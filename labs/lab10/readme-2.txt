section .data
    ; Сообщения
    prompt      db "Как вас зовут (имя фамилия)? ", 0
    prompt_len  equ $ - prompt
    
    prefix      db "Меня зовут: ", 0
    prefix_len  equ $ - prefix
    
    success_msg db "Данные записаны в файл name.txt", 10, 0
    success_len equ $ - success_msg
    
    error_msg   db "Ошибка при создании файла!", 10, 0
    error_len   equ $ - error_msg
    
    newline     db 10
    filename    db "name.txt", 0
    
section .bss
    buffer      resb 256        ; буфер для ввода имени
    name_len    resq 1          ; длина имени
    fd          resq 1          ; файловый дескриптор
    
section .text
    global _start

_start:
    ; ===========================================
    ; Шаг 1: Запрашиваем имя пользователя
    ; ===========================================
    call print_prompt
    
    ; ===========================================
    ; Шаг 2: Читаем имя с клавиатуры
    ; ===========================================
    call read_name
    
    ; ===========================================
    ; Шаг 3: Создаем файл name.txt
    ; ===========================================
    call create_file
    cmp rax, 0
    jl file_error       ; если ошибка при создании файла
    
    ; Сохраняем файловый дескриптор
    mov [fd], rax
    
    ; ===========================================
    ; Шаг 4: Записываем "Меня зовут: " в файл
    ; ===========================================
    mov rdi, [fd]
    mov rsi, prefix
    mov rdx, prefix_len
    call write_to_file
    
    ; ===========================================
    ; Шаг 5: Записываем имя в файл
    ; ===========================================
    mov rdi, [fd]
    mov rsi, buffer
    mov rdx, [name_len]
    call write_to_file
    
    ; ===========================================
    ; Шаг 6: Добавляем перенос строки
    ; ===========================================
    mov rdi, [fd]
    mov rsi, newline
    mov rdx, 1
    call write_to_file
    
    ; ===========================================
    ; Шаг 7: Закрываем файл
    ; ===========================================
    call close_file
    
    ; ===========================================
    ; Шаг 8: Выводим сообщение об успехе
    ; ===========================================
    mov rax, 1
    mov rdi, 1
    mov rsi, success_msg
    mov rdx, success_len
    syscall
    
    ; ===========================================
    ; Шаг 9: Завершаем программу
    ; ===========================================
    jmp exit_program

; ===========================================
; Подпрограмма: Вывод приглашения
; ===========================================
print_prompt:
    mov rax, 1
    mov rdi, 1
    mov rsi, prompt
    mov rdx, prompt_len
    syscall
    ret

; ===========================================
; Подпрограмма: Чтение имени
; ===========================================
read_name:
    mov rax, 0          ; sys_read
    mov rdi, 0          ; stdin
    mov rsi, buffer
    mov rdx, 256
    syscall
    
    ; Сохраняем длину имени (без символа новой строки)
    dec rax
    mov [name_len], rax
    ret

; ===========================================
; Подпрограмма: Создание файла
; ===========================================
create_file:
    mov rax, 2          ; sys_open
    mov rdi, filename
    mov rsi, 0o42       ; O_RDWR|O_CREAT|O_TRUNC
    mov rdx, 0o644      ; rw-r--r--
    syscall
    ret

; ===========================================
; Подпрограмма: Запись в файл
; Вход: rdi - файловый дескриптор
;       rsi - буфер данных
;       rdx - длина данных
; ===========================================
write_to_file:
    mov rax, 1          ; sys_write
    ; rdi уже содержит fd
    ; rsi уже содержит буфер
    ; rdx уже содержит длину
    syscall
    ret

; ===========================================
; Подпрограмма: Закрытие файла
; ===========================================
close_file:
    mov rax, 3          ; sys_close
    mov rdi, [fd]
    syscall
    ret

; ===========================================
; Обработка ошибки файла
; ===========================================
file_error:
    mov rax, 1
    mov rdi, 1
    mov rsi, error_msg
    mov rdx, error_len
    syscall

; ===========================================
; Завершение программы
; ===========================================
exit_program:
    mov rax, 60         ; sys_exit
    xor rdi, rdi        ; код возврата 0
    syscall
